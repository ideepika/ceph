---
name: "Create Backport"
on:
  pull_request:
    types: [ closed ]
env:
  #FIX: org change
  redmine_user_id: dupadhya
  redmine_key: "${{ secrets.REDMINE_KEY }}"
  redmine_passwd: "${{ secrets.REDMINE_PASSWD }}"
  github_token: "${{ secrets.TOKEN }}"
  github_user: dexter816
  fork_remote: https://github.com/dexter816/ceph.git
jobs:
  merge_job:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v2
        with:
          # for pull_request so we can do HEAD^2
          fetch-depth: 2
      - name: Cache dependencies
      # cache dependencies
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/src/script/requirements.txt') }}
          restore-keys: |
           ${{ runner.os }}-pip-
      - name: Check commit message
        run: |
          echo PR #${{ github.event.number }} has been merged
          # FIXME: cache dependencies
          pip3 install python_redmine
          commit_msg=$(git log --format=%B -n 1 HEAD^2)
          tracker_id=$(echo $commit_msg | grep "tracker.ceph" | cut -d"/" -f5)
          echo $tracker_id
          if [[ -n $tracker_id ]]; then
            # fixme: make it secure
            python ./src/script/backport-create-issue $tracker_id:${{ github.event.number }} --user $redmine_user_id --password $redmine_passwd
          fi




